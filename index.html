<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Emotion Analyzer ‚Äì UIT-VSMEC</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{background:#f7f9fc;font-family:system-ui,Arial,sans-serif}
.navbar-brand{font-weight:bold}
.emotion-badge{display:inline-block;padding:.6em 1.2em;border-radius:999px;font-size:1rem}
.emotion-enjoyment { background:#fd7e14;color:#222}
.emotion-sadness { background:#7c5bb9;color:#09203f }
.emotion-anger { background: #ffd54f;color:#222 }
.emotion-disgust { background:#d63384;color:#122 }
.emotion-fear { background:#b3afba;color:#222 }
.emotion-surprise {background:#20c997;color:#222 }
.emotion-other { background:#0dcaf0;color:#222}
.stats-card{padding:1em;border-radius:8px}
.sample-item{padding:.3em 0;border-bottom:1px dashed rgba(0,0,0,0.05)}
pre{white-space:pre-wrap;word-break:break-word;margin:0}
footer{font-size:.9rem;opacity:.8}
</style>
</head>

<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
 <div class="container">
   <a class="navbar-brand" href="#">üáªüá≥ Emotion Analyzer (UIT-VSMEC)</a>
   <span class="text-white small ms-auto">Frontend demo</span>
 </div>
</nav>

<div class="container my-4">
 <div class="row g-4">

  <!-- Left -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-info text-white"><h5 class="mb-0">üîç Ph√¢n t√≠ch c·∫£m x√∫c</h5></div>
      <div class="card-body">
        <textarea id="inputText" class="form-control mb-3" rows="4" placeholder="Nh·∫≠p c√¢u ti·∫øng Vi·ªát..."></textarea>
        <div class="d-grid gap-2">
          <button id="btnAnalyze" class="btn btn-primary">Ph√¢n t√≠ch (API)</button>
          <button id="btnRule" class="btn btn-outline-secondary">Ph√¢n t√≠ch (Rule-based)</button>
        </div>
        <hr>
        <label class="form-label">Ho·∫∑c ch·ªçn file Excel (.xlsx / .xls):</label>
        <input id="excelFile" type="file" class="form-control mb-2" accept=".xlsx,.xls">
        <button id="btnExcel" class="btn btn-outline-dark w-100">Ph√¢n t√≠ch file Excel</button>
      </div>
    </div>

    <div id="resultCard" class="card shadow-sm mt-4 d-none">
      <div class="card-header bg-success text-white"><h6 class="mb-0">üìä K·∫øt qu·∫£</h6></div>
      <div class="card-body">
        <div id="emotionResult"></div>
        <div id="confidenceChart" style="height:220px;"></div>
      </div>
    </div>
  </div>

  <!-- Right -->
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header bg-warning"><h5 class="mb-0">üìà Th·ªëng k√™ d·ªØ li·ªáu</h5></div>
      <div class="card-body">
        <div id="dataStats"></div>
        <div id="emotionDistribution" class="mt-3"></div>
      </div>
    </div>

    <div class="card mt-4 shadow-sm">
      <div class="card-header bg-secondary text-white"><h6 class="mb-0">üìã M·∫´u d·ªØ li·ªáu UIT-VSMEC</h6></div>
      <div class="card-body" style="max-height:300px;overflow:auto">
        <div id="sampleData">ƒêang t·∫£i d·ªØ li·ªáu m·∫´u...</div>
      </div>
    </div>
  </div>
 </div>

 <!-- Batch result -->
 <div id="batchResultCard" class="card shadow-sm mt-4 d-none">
   <div class="card-header bg-danger text-white"><h6 class="mb-0">üìÑ K·∫øt qu·∫£ h√†ng lo·∫°t</h6></div>
   <div class="card-body" id="batchResults"></div>
 </div>
</div>

<footer class="bg-dark text-white text-center py-3">
 <div class="container">Demo nh·∫≠n di·ªán c·∫£m x√∫c ti·∫øng Vi·ªát ‚Äì d·ª±a tr√™n UIT-VSMEC (6 927 c√¢u, 7 nh√£n)</div>
</footer>

<script>
/* ---------- C·∫•u h√¨nh ---------- */
const API_URL = 'http://127.0.0.1:5000/predict';   // URL backend Flask
const USE_BACKEND = true;

/* ---------- B·∫£n ƒë·ªì nh√£n ---------- */
const EMO_VN = {
  'Enjoyment':'Vui',
  'Sadness':'Bu·ªìn',
  'Anger':'Gi·∫≠n',
  'Disgust':'Gh√™ t·ªüm',
  'Fear':'S·ª£ h√£i',
  'Surprise':'Ng·∫°c nhi√™n',
  'Other':'Kh√°c'
};

/* ---------- Rule-based fallback ---------- */
const KEYWORDS = {
  'Enjoyment':['vui','th√≠ch','tuy·ªát','h·∫°nh ph√∫c','haha','üòÑ'],
  'Sadness':['bu·ªìn','kh√≥c','th·∫•t v·ªçng','ch√°n','huhu'],
  'Anger':['gi·∫≠n','t·ª©c','b·ª±c','ƒë·ªì ngu','ƒëm'],
  'Disgust':['gh√™','t·ªüm','bu·ªìn n√¥n'],
  'Fear':['s·ª£','lo l·∫Øng','ho·∫£ng','run'],
  'Surprise':['b·∫•t ng·ªù','ng·∫°c nhi√™n','wow','√¥i tr·ªùi']
};

/* ---------- Helpers ---------- */
function escapeHtml(s){return s.replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]))}
function show(id){document.getElementById(id).classList.remove('d-none')}
function hide(id){document.getElementById(id).classList.add('d-none')}
function getClass(lbl){
  return {
    'Enjoyment':'emotion-enjoyment',
    'Sadness':'emotion-sadness',
    'Anger':'emotion-anger',
    'Disgust':'emotion-disgust',
    'Fear':'emotion-fear',
    'Surprise':'emotion-surprise',
    'Other':'emotion-other'
  }[lbl] || 'emotion-other'
}

/* ---------- Load sample (6 927 c√¢u) ---------- */
async function loadSample(){
  try{
    const res=await fetch('data.json');
    if(!res.ok) throw new Error('Kh√¥ng t√¨m th·∫•y data.json');
    const data=await res.json();
    populateSample(data);
    populateStats(data);
  }catch(e){
    document.getElementById('sampleData').innerHTML='<i>Ch∆∞a c√≥ data.json</i>';
  }
}

function populateSample(arr){
  const el=document.getElementById('sampleData');
  el.innerHTML=arr.slice(0,50).map((r,i)=>{
    const lbl=EMO_VN[r.Emotion]||r.Emotion;
    return `<div class="sample-item"><strong>${i+1}.</strong> ${escapeHtml(r.Sentence)} <span class="badge bg-secondary float-end">${lbl}</span></div>`;
  }).join('');
}

function populateStats(arr){
  const counts={};
  arr.forEach(r=>{counts[r.Emotion]=(counts[r.Emotion]||0)+1});
  const total=arr.length;
  const statsEl=document.getElementById('dataStats');
  statsEl.innerHTML=`
   <div class="row text-center">
     <div class="col-4"><div class="stats-card bg-primary text-white"><h4>${total}</h4><small>T·ªïng c√¢u</small></div></div>
     <div class="col-4"><div class="stats-card bg-success text-white"><h4>${Object.keys(counts).length}</h4><small>Lo·∫°i nh√£n</small></div></div>
     <div class="col-4"><div class="stats-card bg-info text-white"><h4>7</h4><small>Nh√£n UIT-VSMEC</small></div></div>
   </div>`;
  drawDistribution(counts);
}

function drawDistribution(counts){
  const ctx=document.createElement('canvas');
  document.getElementById('emotionDistribution').innerHTML='';
  document.getElementById('emotionDistribution').appendChild(ctx);
  new Chart(ctx,{type:'doughnut',
   data:{labels:Object.keys(counts).map(k=>EMO_VN[k]||k),datasets:[{data:Object.values(counts)}]},
   options:{plugins:{legend:{position:'bottom'}}}});
}

/* ---------- Predict ---------- */
async function predictAPI(text){
  const r=await fetch(API_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
  if(!r.ok) throw new Error('API l·ªói');
  const j=await r.json();
  return {emotion:j.prediction||j.label||'Other',confidence:j.confidence||80};
}

function predictRule(text){
  const t=text.toLowerCase();const score={};
  for(const [lbl,kws] of Object.entries(KEYWORDS)){score[lbl]=0;kws.forEach(k=>{if(t.includes(k))score[lbl]++;})}
  let best='Other',max=0;
  for(const[k,v]of Object.entries(score)){if(v>max){max=v;best=k}}
  return {emotion:best,confidence:Math.min(100,max*20+50)};
}

/* ---------- Display ---------- */
function showResult(text,res){
  show('resultCard');
  document.getElementById('emotionResult').innerHTML=
   `<div><strong>VƒÉn b·∫£n:</strong><pre>${escapeHtml(text)}</pre></div>
    <div class="text-center mt-2">
     <span class="emotion-badge ${getClass(res.emotion)}">${EMO_VN[res.emotion]||res.emotion}</span>
     <div class="mt-2"><strong>ƒê·ªô tin c·∫≠y:</strong> ${res.confidence}%</div>
    </div>`;
  const ctx=document.createElement('canvas');
  document.getElementById('confidenceChart').innerHTML='';
  document.getElementById('confidenceChart').appendChild(ctx);
  new Chart(ctx,{type:'bar',
    data:{labels:[EMO_VN[res.emotion]||res.emotion],datasets:[{data:[res.confidence],backgroundColor:'rgba(54,162,235,0.6)'}]},
    options:{scales:{y:{beginAtZero:true,max:100}}}});
}

/* ---------- Batch Excel ---------- */
function readExcel(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=e=>{
      const wb=XLSX.read(new Uint8Array(e.target.result),{type:'array'});
      resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{defval:''}));
    };
    fr.onerror=reject;
    fr.readAsArrayBuffer(file);
  });
}

async function analyzeExcel(rows){
  const keys=Object.keys(rows[0]);
  const textCol=keys.find(k=>/sentence|text|comment/i.test(k))||keys[0];
  const labelCol=keys.find(k=>/emotion|label/i.test(k))||'';
  const results=[];
  for(const [i,r] of rows.entries()){
    const text=(r[textCol]||'').trim();if(!text)continue;
    let pred={};
    try{pred=USE_BACKEND?await predictAPI(text):predictRule(text);}
    catch{pred=predictRule(text);}
    results.push({idx:i+1,text,gold:r[labelCol]||'',pred:pred.emotion,conf:pred.confidence});
  }
  displayBatch(results);
}

function displayBatch(results){
  show('batchResultCard');
  const tb=['<div class="table-responsive"><table class="table table-sm table-bordered"><thead><tr><th>#</th><th>C√¢u</th><th>Label</th><th>D·ª± ƒëo√°n</th><th>Conf%</th></tr></thead><tbody>'];
  results.forEach(r=>{
    tb.push(`<tr>
      <td>${r.idx}</td>
      <td style="max-width:360px"><pre>${escapeHtml(r.text)}</pre></td>
      <td>${escapeHtml(r.gold)}</td>
      <td><span class="badge bg-secondary">${EMO_VN[r.pred]||r.pred}</span></td>
      <td>${r.conf.toFixed(1)}</td>
    </tr>`);
  });
  tb.push('</tbody></table></div>');
  document.getElementById('batchResults').innerHTML=tb.join('');
}

/* ---------- Events ---------- */
document.getElementById('btnAnalyze').onclick=async()=>{
  const t=document.getElementById('inputText').value.trim();
  if(!t){alert('Nh·∫≠p c√¢u c·∫ßn ph√¢n t√≠ch');return;}
  try{const r=USE_BACKEND?await predictAPI(t):predictRule(t);showResult(t,r);}
  catch{const r=predictRule(t);showResult(t,r);}
};

document.getElementById('btnRule').onclick=()=>{
  const t=document.getElementById('inputText').value.trim();
  if(!t){alert('Nh·∫≠p c√¢u c·∫ßn ph√¢n t√≠ch');return;}
  showResult(t,predictRule(t));
};

document.getElementById('btnExcel').onclick=async()=>{
  const f=document.getElementById('excelFile').files[0];
  if(!f){alert('Ch·ªçn file Excel tr∆∞·ªõc');return;}
  const rows=await readExcel(f);
  analyzeExcel(rows.slice(0,2000));
};

/* ---------- Init ---------- */
loadSample();
</script>
</body>
</html>
